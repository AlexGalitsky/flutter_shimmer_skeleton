name: Flutter

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get

      - name: Analyze project source
        run: flutter analyze

  test:
    name: Tests with Coverage
    runs-on: ubuntu-latest
    outputs:
      coverage_percentage: ${{ steps.coverage.outputs.percentage }}
      test_outcome: ${{ steps.tests.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get

      - name: Install lcov
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov

      - name: Run tests with coverage
        id: tests
        continue-on-error: true
        run: flutter test --coverage

      - name: Debug coverage file
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "=== Coverage file exists ==="
            echo "File size: $(wc -l < coverage/lcov.info) lines"
            echo "=== First 20 lines of coverage file ==="
            head -20 coverage/lcov.info
            echo "=== Looking for LF and LH lines ==="
            grep -E '^(LF|LH):' coverage/lcov.info | head -5
          else
            echo "Coverage file not found!"
            ls -la coverage/ || echo "Coverage directory doesn't exist"
          fi

      - name: Parse coverage percentage
        id: coverage
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "Parsing coverage from lcov.info..."
            
            # Method 1: Try to use lcov --summary (most reliable)
            LCOV_SUMMARY=$(lcov --summary coverage/lcov.info 2>&1 || echo "")
            echo "=== LCOV Summary output ==="
            echo "$LCOV_SUMMARY"
            
            # Extract percentage from summary (look for "lines......: XX.X%")
            # Pattern: "lines......: XX.X%"
            COVERAGE=$(echo "$LCOV_SUMMARY" | grep -E 'lines\.\.\.\.\.\.:\s*[0-9.]+%' | sed 's/.*lines\.\.\.\.\.\.:\s*\([0-9.]*\)%.*/\1/' | head -1)
            
            if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "" ]; then
              echo "Method 1 failed, trying method 2..."
              
              # Method 2: Calculate from LF and LH totals in the file
              # Sum all LF (lines found) and LH (lines hit) values
              TOTAL=$(grep -E '^LF:' coverage/lcov.info | awk -F: '{sum+=$2} END {print sum+0}')
              HIT=$(grep -E '^LH:' coverage/lcov.info | awk -F: '{sum+=$2} END {print sum+0}')
              
              echo "Total lines found (LF): $TOTAL"
              echo "Total lines hit (LH): $HIT"
              
              if [ -n "$TOTAL" ] && [ -n "$HIT" ] && [ "$TOTAL" != "0" ] && [ "$TOTAL" -gt 0 ]; then
                COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($HIT/$TOTAL)*100}")
                echo "Calculated coverage: $COVERAGE%"
              else
                echo "Method 2 failed, trying method 3..."
                
                # Method 3: Try to extract any percentage from summary text
                COVERAGE=$(echo "$LCOV_SUMMARY" | grep -oE '[0-9]+\.[0-9]+%' | head -1 | sed 's/%//')
                
                if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "" ]; then
                  COVERAGE="0.0"
                  echo "All methods failed, defaulting to 0.0%"
                else
                  echo "Extracted coverage from summary text: $COVERAGE%"
                fi
              fi
            else
              echo "Extracted coverage from summary: $COVERAGE%"
            fi
            
            # Ensure COVERAGE is a valid number
            if ! echo "$COVERAGE" | grep -qE '^[0-9]+\.?[0-9]*$'; then
              echo "Warning: Invalid coverage value '$COVERAGE', defaulting to 0.0"
              COVERAGE="0.0"
            fi
            
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "=== Final coverage: $COVERAGE% ==="
          else
            echo "Coverage file not found at coverage/lcov.info"
            echo "percentage=0.0" >> $GITHUB_OUTPUT
          fi

      - name: Output coverage results
        if: always()
        run: |
          echo "Test outcome: ${{ steps.tests.outcome }}"
          echo "Coverage percentage: ${{ steps.coverage.outputs.percentage }}%"

  update-badge:
    name: Update Coverage Badge
    needs: test
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Update coverage badge in README files
        run: |
          # Use Python to update README files
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          # Get coverage percentage and test outcome from previous job
          coverage_percent = os.environ.get('COVERAGE_PERCENT', '0.0')
          test_outcome = os.environ.get('TEST_OUTCOME', '')
          
          # Determine color based on coverage percentage
          try:
              coverage_float = float(coverage_percent)
              if coverage_float >= 80:
                  color = 'success'
              elif coverage_float >= 60:
                  color = 'yellow'
              elif coverage_float >= 40:
                  color = 'orange'
              else:
                  color = 'critical'
          except ValueError:
              color = 'lightgrey'
          
          # Create badge with coverage percentage
          if test_outcome == 'success':
              badge = f'![Coverage](https://img.shields.io/badge/coverage-{coverage_percent}%25-{color}?style=flat-square)'
          else:
              badge = f'![Coverage](https://img.shields.io/badge/coverage-{coverage_percent}%25-{color}?style=flat-square&label=tests-failing)'
          
          # Pattern to find and replace the test badge
          pattern = r'<!-- TEST_BADGE_START -->.*?<!-- TEST_BADGE_END -->'
          replacement = f'<!-- TEST_BADGE_START -->\n{badge}\n<!-- TEST_BADGE_END -->'
          
          # Update README.md and README.ru.md
          for filename in ['README.md', 'README.ru.md']:
              try:
                  with open(filename, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  if re.search(pattern, content, re.DOTALL):
                      # Update existing badge
                      content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  else:
                      # Add badge after title if not found
                      content = re.sub(
                          r'(# flutter_shimmer_skeleton\n)',
                          r'\1\n<!-- TEST_BADGE_START -->\n' + badge + '\n<!-- TEST_BADGE_END -->\n',
                          content
                      )
                  
                  with open(filename, 'w', encoding='utf-8') as f:
                      f.write(content)
              except FileNotFoundError:
                  # Skip if file doesn't exist
                  pass
          PYTHON_SCRIPT
        env:
          COVERAGE_PERCENT: ${{ needs.test.outputs.coverage_percentage || '0.0' }}
          TEST_OUTCOME: ${{ needs.test.outputs.test_outcome || 'failure' }}

      - name: Commit and push README updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --exit-code README.md README.ru.md || (git add README.md README.ru.md && git commit -m "chore: update coverage badge [skip ci]" && git push)
