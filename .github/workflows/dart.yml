name: Flutter

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze project source
        run: flutter analyze

      - name: Install lcov
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov

      - name: Run tests with coverage
        id: tests
        continue-on-error: true
        run: flutter test --coverage

      - name: Parse coverage percentage
        id: coverage
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            # Try to extract coverage from lcov summary first
            LCOV_SUMMARY=$(lcov --summary coverage/lcov.info 2>&1)
            COVERAGE=$(echo "$LCOV_SUMMARY" | grep -E 'lines\.\.\.\.\.\.: [0-9.]+%' | grep -oE '[0-9.]+' | head -1)
            
            if [ -z "$COVERAGE" ]; then
              # Fallback: calculate from lcov.info file directly
              TOTAL=$(grep -E '^LF:' coverage/lcov.info | head -1 | grep -oE '[0-9]+' | head -1)
              HIT=$(grep -E '^LH:' coverage/lcov.info | head -1 | grep -oE '[0-9]+' | head -1)
              
              if [ -n "$TOTAL" ] && [ -n "$HIT" ] && [ "$TOTAL" -gt 0 ]; then
                COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($HIT/$TOTAL)*100}")
              else
                # Last fallback: try to parse from summary text
                COVERAGE=$(echo "$LCOV_SUMMARY" | grep -E '[0-9.]+%' | head -1 | grep -oE '[0-9.]+' | head -1)
                if [ -z "$COVERAGE" ]; then
                  COVERAGE="0.0"
                fi
              fi
            fi
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE%"
          else
            echo "percentage=0.0" >> $GITHUB_OUTPUT
            echo "Coverage file not found"
          fi

      - name: Update coverage badge in README files
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Use Python to update README files
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          # Get coverage percentage and test outcome
          coverage_percent = os.environ.get('COVERAGE_PERCENT', '0.0')
          test_outcome = os.environ.get('TEST_OUTCOME', '')
          
          # Determine color based on coverage percentage
          try:
              coverage_float = float(coverage_percent)
              if coverage_float >= 80:
                  color = 'success'
              elif coverage_float >= 60:
                  color = 'yellow'
              elif coverage_float >= 40:
                  color = 'orange'
              else:
                  color = 'critical'
          except ValueError:
              color = 'lightgrey'
          
          # Create badge with coverage percentage
          if test_outcome == 'success':
              badge = f'![Coverage](https://img.shields.io/badge/coverage-{coverage_percent}%25-{color}?style=flat-square)'
          else:
              badge = f'![Coverage](https://img.shields.io/badge/coverage-{coverage_percent}%25-{color}?style=flat-square&label=tests-failing)'
          
          # Pattern to find and replace the test badge
          pattern = r'<!-- TEST_BADGE_START -->.*?<!-- TEST_BADGE_END -->'
          replacement = f'<!-- TEST_BADGE_START -->\n{badge}\n<!-- TEST_BADGE_END -->'
          
          # Update README.md and README.ru.md
          for filename in ['README.md', 'README.ru.md']:
              try:
                  with open(filename, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  if re.search(pattern, content, re.DOTALL):
                      # Update existing badge
                      content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  else:
                      # Add badge after title if not found
                      content = re.sub(
                          r'(# flutter_shimmer_skeleton\n)',
                          r'\1\n<!-- TEST_BADGE_START -->\n' + badge + '\n<!-- TEST_BADGE_END -->\n',
                          content
                      )
                  
                  with open(filename, 'w', encoding='utf-8') as f:
                      f.write(content)
              except FileNotFoundError:
                  # Skip if file doesn't exist
                  pass
          PYTHON_SCRIPT
        env:
          COVERAGE_PERCENT: ${{ steps.coverage.outputs.percentage }}
          TEST_OUTCOME: ${{ steps.tests.outcome }}

      - name: Commit and push README updates
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --exit-code README.md README.ru.md || (git add README.md README.ru.md && git commit -m "chore: update coverage badge [skip ci]" && git push)
