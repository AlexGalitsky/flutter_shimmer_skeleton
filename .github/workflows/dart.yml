name: Flutter

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: flutter format --output=none --set-exit-if-changed .

      - name: Analyze project source
        run: flutter analyze

      - name: Run tests
        id: tests
        continue-on-error: true
        run: flutter test

      - name: Update test badge in README files
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Use Python to update README files
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          # Determine badge based on test outcome
          test_outcome = os.environ.get('TEST_OUTCOME', '')
          if test_outcome == 'success':
              badge = '![Tests](https://img.shields.io/badge/tests-passing-success?style=flat-square)'
          else:
              badge = '![Tests](https://img.shields.io/badge/tests-failing-critical?style=flat-square)'
          
          # Pattern to find and replace the test badge
          pattern = r'<!-- TEST_BADGE_START -->.*?<!-- TEST_BADGE_END -->'
          replacement = f'<!-- TEST_BADGE_START -->\n{badge}\n<!-- TEST_BADGE_END -->'
          
          # Update README.md
          for filename in ['README.md', 'README.ru.md']:
              try:
                  with open(filename, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  if re.search(pattern, content, re.DOTALL):
                      # Update existing badge
                      content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  else:
                      # Add badge after title if not found
                      content = re.sub(
                          r'(# flutter_shimmer_skeleton\n)',
                          r'\1\n<!-- TEST_BADGE_START -->\n' + badge + '\n<!-- TEST_BADGE_END -->\n',
                          content
                      )
                  
                  with open(filename, 'w', encoding='utf-8') as f:
                      f.write(content)
              except FileNotFoundError:
                  # Skip if file doesn't exist
                  pass
          PYTHON_SCRIPT
        env:
          TEST_OUTCOME: ${{ steps.tests.outcome }}

      - name: Commit and push README updates
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --exit-code README.md README.ru.md || (git add README.md README.ru.md && git commit -m "chore: update test status badge [skip ci]" && git push)
